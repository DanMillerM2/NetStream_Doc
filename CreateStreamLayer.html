<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>3&nbsp; Build a stream layer – NetStream: Programs for watershed analyses</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./summary.html" rel="next">
<link href="./attributeLists.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-8da5b4427184b79ecddefad3d342027e.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./CreateStreamLayer.html">Tasks</a></li><li class="breadcrumb-item"><a href="./CreateStreamLayer.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Build a stream layer</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">NetStream: Programs for watershed analyses</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hello</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./prerequisites.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Prerequisites</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./programs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Programs</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Bldgrds.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Bldgrds</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Data-field options</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./attributeLists.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Attribute Lists</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Tasks</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./CreateStreamLayer.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Build a stream layer</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./summary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Summary</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#flow-direction" id="toc-flow-direction" class="nav-link active" data-scroll-target="#flow-direction"><span class="header-section-number">3.1</span> Flow Direction</a></li>
  <li><a href="#closed-depressions" id="toc-closed-depressions" class="nav-link" data-scroll-target="#closed-depressions"><span class="header-section-number">3.2</span> Closed Depressions</a>
  <ul class="collapse">
  <li><a href="#fillling" id="toc-fillling" class="nav-link" data-scroll-target="#fillling"><span class="header-section-number">3.2.1</span> Fillling</a></li>
  <li><a href="#carving" id="toc-carving" class="nav-link" data-scroll-target="#carving"><span class="header-section-number">3.2.2</span> Carving</a></li>
  </ul></li>
  <li><a href="#channel-initiation" id="toc-channel-initiation" class="nav-link" data-scroll-target="#channel-initiation"><span class="header-section-number">3.3</span> Channel initiation</a>
  <ul class="collapse">
  <li><a href="#local-topographic-position" id="toc-local-topographic-position" class="nav-link" data-scroll-target="#local-topographic-position"><span class="header-section-number">3.3.1</span> Local topographic position</a></li>
  <li><a href="#area-slope-threshold" id="toc-area-slope-threshold" class="nav-link" data-scroll-target="#area-slope-threshold"><span class="header-section-number">3.3.2</span> Area-slope threshold</a></li>
  <li><a href="#plan-curvature" id="toc-plan-curvature" class="nav-link" data-scroll-target="#plan-curvature"><span class="header-section-number">3.3.3</span> Plan curvature</a></li>
  <li><a href="#minimum-flow-length" id="toc-minimum-flow-length" class="nav-link" data-scroll-target="#minimum-flow-length"><span class="header-section-number">3.3.4</span> Minimum flow length</a></li>
  </ul></li>
  <li><a href="#channel-courses" id="toc-channel-courses" class="nav-link" data-scroll-target="#channel-courses"><span class="header-section-number">3.4</span> Channel Courses</a>
  <ul class="collapse">
  <li><a href="#flow-indicators" id="toc-flow-indicators" class="nav-link" data-scroll-target="#flow-indicators"><span class="header-section-number">3.4.1</span> Flow indicators</a></li>
  <li><a href="#sec-watermask" id="toc-sec-watermask" class="nav-link" data-scroll-target="#sec-watermask"><span class="header-section-number">3.4.2</span> Water mask</a></li>
  <li><a href="#dem-derivatives" id="toc-dem-derivatives" class="nav-link" data-scroll-target="#dem-derivatives"><span class="header-section-number">3.4.3</span> DEM derivatives</a></li>
  </ul></li>
  <li><a href="#sec-flowDiversions" id="toc-sec-flowDiversions" class="nav-link" data-scroll-target="#sec-flowDiversions"><span class="header-section-number">3.5</span> Flow diversions</a></li>
  <li><a href="#typical-workflow" id="toc-typical-workflow" class="nav-link" data-scroll-target="#typical-workflow"><span class="header-section-number">3.6</span> Typical Workflow</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./CreateStreamLayer.html">Tasks</a></li><li class="breadcrumb-item"><a href="./CreateStreamLayer.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Build a stream layer</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span id="sec-buildStreamLayer" class="quarto-section-identifier"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Build a stream layer</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>It seems straightforward: define a flow direction for each DEM cell, iteratively trace flow lines downstream summing cell area as we go to create a flow accumulation raster, set a flow threshold, and voila, a stream layer. That’s basically it, but there are complications. The first two items below discuss issues that are hardwired into <a href="Bldgrds.html" class="quarto-xref"><span>Chapter 1</span></a>. Everything else has user-defined options, although default values are built in for most.</p>
<section id="flow-direction" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="flow-direction"><span class="header-section-number">3.1</span> Flow Direction</h2>
<p>The direction of flow for water draining out of a DEM cell is not uniquely defined. Each cell has 8 adjacent cells. Depending on the shape of the ground surface interpolated from the 9 elevation values at the midpoints of the cells, each adjacent cell may contribute all, some portion, or none of its area to the central cell and the central cell may contribute all, some portion, or none of its area (and the accumulated area of the upslope cells that flows into it) to each of the adjacent cells. The simplest strategy is to have all flow from the central cell go to one of the 8 adjacent cells. This is the “D-8” flow-direction algorithm <span class="citation" data-cites="jenson1988">(<a href="references.html#ref-jenson1988" role="doc-biblioref">Jenson and Domingue 1988</a>)</span>. It provides a poor estimate of contributing area to a cell that is biased by the 8 flow-direction options. One must also decide which of the 8 adjacent cells to direct flow to, and there are a variety of strategies for that. When D-8 flow paths are needed, we use the D8-LTD algorithm <span class="citation" data-cites="orlandini2003">(<a href="references.html#ref-orlandini2003" role="doc-biblioref">Orlandini et al. 2003</a>)</span>, which corrects for the directional bias. A variety of flow-direction algorithms have been developed that accommodate flow in any direction and can direct flow to multiple downslope adjacent cells <span class="citation" data-cites="wilson2008">(<a href="references.html#ref-wilson2008" role="doc-biblioref">Wilson et al. 2008</a>)</span> and thus allow for flow dispersion. We use the D-infinity algorithm <span class="citation" data-cites="tarboton1997">(<a href="references.html#ref-tarboton1997" role="doc-biblioref">Tarboton 1997</a>)</span>, which allows flow into one or two adjacent cells. Flow accumulation is then calculated using the D-infinity flow directions, until the criteria for channel initiation are met. Downslope of that point, we use D-8 to prevent flow dispersion out of the channel.</p>
</section>
<section id="closed-depressions" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="closed-depressions"><span class="header-section-number">3.2</span> Closed Depressions</h2>
<p>These may be actual depressions with no outflow, in which case all inflowing water infiltrates to groundwater, or they be actual depressions with an outflow not visible from the DEM (e.g., road prisms with culverts), or they may be artifacts or errors in the DEM. In general, we want to define a flow path to an outlet from the DEM for every DEM cell. Even for closed depressions with no outlet, water that flows into them exits through some groundwater flow path and eventually flows to a stream somewhere downslope or out of the area represented with the DEM. Two primary approaches are used to deal with closed depressions <span class="citation" data-cites="wang2019">(<a href="references.html#ref-wang2019" role="doc-biblioref">Wang, Qin, and Zhu 2019</a>)</span>.</p>
<section id="fillling" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="fillling"><span class="header-section-number">3.2.1</span> Fillling</h3>
<p>This is the simplest. The depression is filled to the elevation of its lowest pour point (where water would spill out if the depression were filled). Flow directions through the closed depression are then directed toward the pour point. This option destroys any information about flow directions within the closed depression, which we would rather avoid.</p>
</section>
<section id="carving" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="carving"><span class="header-section-number">3.2.2</span> Carving</h3>
<p>A path is carved from the depression pour point to the lowest point in the depression and from to a location along the flow path from the pour point where the elevation becomes less than or equal to the lowest point in the depression. Flow within the depression is then directed to the lowest point and then out of the depression along the carved path <span class="citation" data-cites="soille2003">(<a href="references.html#ref-soille2003" role="doc-biblioref">Soille, Vogt, and Colombo 2003</a>)</span>. The flow paths from the pour point heading into and away from the depression follow D8-LTD flow directions. This is the preferred option and the one used in bldgrds.</p>
</section>
</section>
<section id="channel-initiation" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="channel-initiation"><span class="header-section-number">3.3</span> Channel initiation</h2>
<p>We need to specify the conditions where channels initiate. This determines the upslope extent of the channel network and the channel density. We have several strategies:</p>
<section id="local-topographic-position" class="level3" data-number="3.3.1">
<h3 data-number="3.3.1" class="anchored" data-anchor-id="local-topographic-position"><span class="header-section-number">3.3.1</span> Local topographic position</h3>
<p>For high-resolution DEMs interpolated from high-density ground returns (e.g., &gt;1/m<sup>2</sup>), channels are visible directly in the DEM, as shown in <a href="#fig-visibleChannels" class="quarto-xref">Figure&nbsp;<span>3.1</span></a> below. Channels can be highlighted using a measure of local topographic position (LTP), which provides an indicator of the elevation of a DEM grid point relative to its neighbors. Absolute LTP measures give the difference in elevation of the grid point compared to the mean or median grid-point elevations within a specified circular neighborhood. Relative measures normalize that elevation difference by some measure of elevation variability in the neighborhood. Deviation from mean elevation (DEV), for example, divides the difference from mean elevation by the standard deviation of DEM grid-point elevations within the neighborhood <span class="citation" data-cites="newman2018">(<a href="references.html#ref-newman2018" role="doc-biblioref">Newman, Lindsay, and Cockburn 2018</a>)</span>. Thus, a small channel incised 0.25 meters traversing flat, low-relief terrain (with a small standard deviation in elevation values) will have a large DEV value compared to a small channel incised 0.25 meters traversing steep, rough terrain (with a larger standard deviation). For determining upslope channel extent, we can specify an LTP threshold value and exclude channel initiation in areas where the LTP value is greater than that threshold (i.e., channel incision is too small). One must decide on whether to use an absolute or relative measure and on the appropriate length scale for the local neighborhood. I find an absolute measure easier to interpret than a relative measure, because it provides a direct estimate of the depth of channel incision; I can decide that traced channels begin only when a channel is incised to more than 0.2 meters (LTP &lt; -0.2), for example. The radius to choose for the local neighborhood should be set relative to the resolution of the DEM, the roughness of the terrain (greater roughness requires larger neighborhoods), and the smallest width of channels you want to identify. Typically, at their upslope extent, channels are less than a meter wide, so a radius of five meters or more will suffice for calculating LTP.</p>
<div id="fig-visibleChannels" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-cap="Channel features visible in a low-gradient region of a high-resolution (1m) DEM, Sprague River Basin, Southern Oregon">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-visibleChannels-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/clipboard-1193431410.png" class="img-fluid figure-img" data-fig-cap="Channel features visible in a low-gradient region of a high-resolution (1m) DEM, Sprague River Basin, Southern Oregon">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-visibleChannels-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.1: Channel features visible in a low-gradient region of a high-resolution (1m) DEM, Sprague River Basin, Southern Oregon
</figcaption>
</figure>
</div>
</section>
<section id="area-slope-threshold" class="level3" data-number="3.3.2">
<h3 data-number="3.3.2" class="anchored" data-anchor-id="area-slope-threshold"><span class="header-section-number">3.3.2</span> Area-slope threshold</h3>
<p>Where the lidar ground-return-point density is insufficient to resolve channels at their upslope extent, we need to infer channel-initiation locations indirectly. One strategy for this is to estimate where on the landscape there may be sufficient flowing water to erode a channel. The contributing (drainage) area to any point on the landscape indicates the upslope area from which overland flow and water infiltrating to shallow subsurface flow through the soil can originate. Hence, differences in contributing area provide indicators of relative differences in overland- and shallow-subsurface discharge; greater contributing area implies greater discharge. This is the idea behind using thresholds in contributing area to estimate upslope channel extent: for a given climate and terrain, some minimum contributing area is required for sufficient discharge to erode a channel. The erosive power of water depends not only on how much water there is, but also on the steepness of the slope it is flowing over or through. Hence, threshold values for functions of contributing area and ground-surface slope may provide better indicators of where channels initiate than contributing area alone. We use the function AS<sup>e</sup>, where A is contributing area, S is tangent of the ground-surface gradient, and e is a user-specified exponent <span class="citation" data-cites="montgomery1993">(<a href="references.html#ref-montgomery1993" role="doc-biblioref">Montgomery and Foufoula-Georgiou 1993</a>)</span>. Contributing area may be specified as specific contributing area, which is the contributing area divided by the length of a contour line crossed by flow exiting the DEM cell <span class="citation" data-cites="gallant2011">(<a href="references.html#ref-gallant2011" role="doc-biblioref">Gallant and Hutchinson 2011</a>)</span>. This accounts for effects of topographic convergence and divergence on the depth of flow and is the default in bldgrds.</p>
<p>Basin topography is found to exhibit certain scaling relationships between contributing area and gradient that delineate divergent, convergent, and channelized topography <span class="citation" data-cites="ijjasz-vasquez1995">(<a href="references.html#ref-ijjasz-vasquez1995" role="doc-biblioref">Ijjasz-Vasquez and Bras 1995</a>)</span>. We capitalize on these to calibrate threshold values for channel initiation. Following <span class="citation" data-cites="clarke2008a">Clarke, Burnett, and Miller (<a href="references.html#ref-clarke2008a" role="doc-biblioref">2008</a>)</span>, we plot channel density as a function of the AS<sup>e</sup> value and look for the inflection in log-log plots that indicate a transition to the channelized regime, as shown in <a href="#fig-inflection" class="quarto-xref">Figure&nbsp;<span>3.2</span></a> below. With the “CALIBRATE” keyword, bldgrds will generate an output comma delimited file (.csv) with which to construct this graph.</p>
<div id="fig-inflection" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-cap="Log-log plot of channel density versus the AS2 threshold value. The inflection to higher densities indicates a transition to convergent topography.">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-inflection-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/clipboard-89317225.png" class="img-fluid figure-img" data-fig-cap="Log-log plot of channel density versus the AS2 threshold value. The inflection to higher densities indicates a transition to convergent topography." width="800">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-inflection-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.2: Log-log plot of channel density versus the AS2 threshold value. The inflection to higher densities indicates a transition to convergent topography.
</figcaption>
</figure>
</div>
<p>This provides a ball-park estimate of the threshold value appropriate for the terrain as represented with the DEM. Plots are produced separately for steep terrain and low-gradient terrain, under the assumption that channel-forming processes may differ, e.g., landsliding on steep terrain and fluvial erosion on low-gradient terrain.</p>
<div id="fig-areaslope" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-areaslope-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/clipboard-2774780771.png" class="img-fluid figure-img" width="1770">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-areaslope-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.3: Slope-area thresholds differentiating divergent and convergent topography for well-resolved channels shown in the left panel and for poorly resolved channels shown in the right panel.
</figcaption>
</figure>
</div>
</section>
<section id="plan-curvature" class="level3" data-number="3.3.3">
<h3 data-number="3.3.3" class="anchored" data-anchor-id="plan-curvature"><span class="header-section-number">3.3.3</span> Plan curvature</h3>
<p>Plan curvature measures the rate of change in elevation measured in a direction tangent to a contour line; it indicates the curvature of the contour. Tangential curvature is similar, but measures the rate of change relative to a plane oriented tangent to the ground surface, whereas plan curvature measures curvature relative to a horizontal plane <span class="citation" data-cites="minár2020">(<a href="references.html#ref-minár2020" role="doc-biblioref">Minár, Evans, and Jenčo 2020</a>)</span>. Both provide another measure for topographic indication of presence of a channel. Bldgrds has the option to specify thresholds of plan (or tangential) curvature for channel initiation. These thresholds can be determined by building curvature rasters using the makegrids program, classifying by proposed threshold values, and plotting on a shaded relief image to see where a proposed threshold would allow channel initiation. The LTP thresholds described above provide a similar and more easily interpreted method of using topography inferred from the DEM for identifying channels.</p>
</section>
<section id="minimum-flow-length" class="level3" data-number="3.3.4">
<h3 data-number="3.3.4" class="anchored" data-anchor-id="minimum-flow-length"><span class="header-section-number">3.3.4</span> Minimum flow length</h3>
<p>Bldgrds iteratively traverses every flow path within a DEM in a downslope direction and checks each cell to see if it meets the channel-initiation criteria. As seen in the <a href="#fig-visibleChannels" class="quarto-xref">Figure&nbsp;<span>3.1</span></a> and <a href="#fig-areaslope" class="quarto-xref">Figure&nbsp;<span>3.3</span></a> above, the criteria can be met for some portion of the flow path, but then no longer be met further downslope. Bldgrds requires specification of the minimum length over which the initiation criteria must be met before it will initialize a channel. The appropriate length depends on the resolution of the DEM and on the roughness of the terrain. If topographic channel indicators are indistinct, small zones where initiation thresholds are met can arise from noise in the DEM or small-scale roughness in the terrain.</p>
</section>
</section>
<section id="channel-courses" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="channel-courses"><span class="header-section-number">3.4</span> Channel Courses</h2>
<p>The cell-to-cell D8 flow paths used once channel initiation is met do not always follow the same course that the actual channels do. Sometimes evidence of the channel flow path is not visible in the DEM, sometimes there are multiple options, sometimes noise in the DEM misdirects the flow path. It can help to use information from DEM cells beyond those immediately adjacent and to bring in information from other data sources. Here are options used by bldgrds.</p>
<section id="flow-indicators" class="level3" data-number="3.4.1">
<h3 data-number="3.4.1" class="anchored" data-anchor-id="flow-indicators"><span class="header-section-number">3.4.1</span> Flow indicators</h3>
<p>Topographic indicators of a channel can also be used to guide channelized flow paths. The flowcat program (for flow categorization) uses one to four such indicators: 1) a threshold in flow accumulation calculated with D-infinity flow directions and no channel initiation, 2) geomorphon valley and pit types <span class="citation" data-cites="stepinski2011">Jasiewicz and Stepinski (<a href="references.html#ref-jasiewicz2013" role="doc-biblioref">2013</a>)</span>, 3) a threshold in plan (or tangential) curvature, and 4) a threshold for deviation from mean elevation (DEV). FlowCat creates a raster with each cell indicating the number of specified flow indicators that are met at each DEM cell. If all four indicators are used, then raster values range from 0 to 4. Bldgrds preferentially directs channels towards raster-cell values greater than zero, or greater than a specified minimum (e.g., if all four indicators are used, a minimum of two indicators must be met). This is done by excavating the corresponding cells in the DEM by a multiple of the flow-indicator raster.</p>
</section>
<section id="sec-watermask" class="level3" data-number="3.4.2">
<h3 data-number="3.4.2" class="anchored" data-anchor-id="sec-watermask"><span class="header-section-number">3.4.2</span> Water mask</h3>
<p>Infrared laser signals are largely absorbed by water and suffer from specular reflections, so there are few or no signal returns from open water, as illustrated in <a href="#fig-RGB_Infrared" class="quarto-xref">Figure&nbsp;<span>3.4</span></a> below.</p>
<div id="fig-RGB_Infrared" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-RGB_Infrared-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/RGB_Infrared.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-RGB_Infrared-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.4: The upper panel shows a natural color NAIP (National Agriculture Imagery Program) image, the lower panel shows the same area with only the infrared ban. From a portion of the Sprague River Basin in Southern Oregon.
</figcaption>
</figure>
</div>
<p>Lidar DEMs often have areas of water “hydroflattened”, so that the open-water zone has a single uniform elevation or a uniformly downstream decreasing elevation. In other cases, elevations over the open-water zone are interpolated from ground returns on either side, which can generate noisy DEM elevation values through the zone of open water. This can result in zig-zaggy flow paths, as shown in <a href="#fig-nomask" class="quarto-xref">Figure&nbsp;<span>3.5</span></a> below, which then overestimate channel length and affect values of corresponding derivatives, such as channel gradient.</p>
<div id="fig-nomask" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-nomask-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/noMask.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-nomask-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.5: Traced channel flow path (orange line) shown on a shaded relief image for the same area in @fig-RGB_Infrared.
</figcaption>
</figure>
</div>
<p>We want channel flow paths through zones of open water to be smooth and to track through the center of the open-water zone. To accomplish that, we can provide bldgrds with a separate raster or polygonal water-mask layer. Bldgrds will direct flow paths through the center of these zones.</p>
<div id="fig-withMask" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-withMask-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/withMask.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-withMask-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.6: The channel centerline (blue line) traced through the center of the water mask polygon (light blue).
</figcaption>
</figure>
</div>
<p>In some cases, breaklines for hydroflattening are provided with lidar-derived DEMs. In other cases, we can build a water mask using multi-band imagery, like that shown in @fig-RGB_Infrared above. Open water appears dark in infra-red bands and can be delineated using image segmentation. Program waterMaskByTopo can generate a water-mask raster using the infrared band from e.g., NAIP. It also uses thresholds in DEV (Deviation from Mean Elevation, a Topographic Position Index) and gradient to distinguish shadows.</p>
</section>
<section id="dem-derivatives" class="level3" data-number="3.4.3">
<h3 data-number="3.4.3" class="anchored" data-anchor-id="dem-derivatives"><span class="header-section-number">3.4.3</span> DEM derivatives</h3>
<p>Azimuth, plan curvature, and the direction of steepest descent can also be used with varying degrees of influence to guide channelized flow directions. Azimuth and plan curvature are measured over a specified length scale. By specifying a length greater than the DEM grid-point spacing, azimuth and curvature use information beyond the elevation of adjacent points, which can reduce the influence of noise in the DEM. It can also cause flow paths to deviate from the steepest-descent path to an adjacent cell. One or more of these indicators may be used and, if more than one are specified, different degrees of influence can be specified for each. The choice of indicators, of length scales, and of the degree of influence to specify requires iterative experimentation.</p>
</section>
</section>
<section id="sec-flowDiversions" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="sec-flowDiversions"><span class="header-section-number">3.5</span> Flow diversions</h2>
<p>High-resolution lidar DEMs resolve road prisms and other potential blockages to channel flow. The carving algorithm used to drain closed depressions will often trace the correct flow path, but not in all cases, as shown in <a href="#fig-roadDiversions" class="quarto-xref">Figure&nbsp;<span>3.7</span></a> below. If these apparent blockages have drainage structures, such as culverts, not visible in the DEM, these need to be specified from other data sources.</p>
<div id="fig-roadDiversions" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-roadDiversions-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/noCrossings.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-roadDiversions-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.7: Channel courses (orange lines) are diverted by the road visible on the north side of the river in this shaded relief image from the Coast Range of Oregon.
</figcaption>
</figure>
</div>
<p>Typically, such other data sources are not available and the likely locations of culverts need to be manually digitized. This task is iterative: building a stream layer, looking for diversions, digitizing a culvert or drainage location, rebuilding the stream layer, and repeating until satisfied with the stream layer. Such manually digitized drainage structures are illustrated for the area shown in <a href="#fig-roadDiversions" class="quarto-xref">Figure&nbsp;<span>3.7</span></a> in <a href="#fig-roadCrossings" class="quarto-xref">Figure&nbsp;<span>3.8</span></a> below.</p>
<div id="fig-roadCrossings" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-roadCrossings-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/withCrossings.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-roadCrossings-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.8: Traced channel courses (blue lines) after manually adding likely culvert locations (black lines).
</figcaption>
</figure>
</div>
</section>
<section id="typical-workflow" class="level2" data-number="3.6">
<h2 data-number="3.6" class="anchored" data-anchor-id="typical-workflow"><span class="header-section-number">3.6</span> Typical Workflow</h2>
<p>With high-resolution DEMs, a default strategy for channel initiation and flow-path routing is:</p>
<ol type="1">
<li><p>Run program bldgrds with the “CALIBRATE” keyword (see <a href="Bldgrds.html" class="quarto-xref"><span>Chapter 1</span></a>). This will generate a .csv file with the channel density as a function of the AS<sup>e</sup> threshold value. Use this to determine appropriate threshold values (one for steep terrain, another for low-gradient terrain) for the DEM. The default exponent is 2 <span class="citation" data-cites="montgomery1993">(as suggested in <a href="references.html#ref-montgomery1993" role="doc-biblioref">Montgomery and Foufoula-Georgiou 1993</a>)</span>, but this can be changed to any desired value. A calibration run of bldgrds will also create a binary floating point raster (threshold_ID.flt) showing the AS<sup>e</sup> value for each DEM cell.</p></li>
<li><p>Use program makegrids to create hillslope-gradient and tangential-curvature rasters for the DEM. Use program DEV to produce a Deviation from Mean Elevation (DEV) raster. Use length scales that span several DEM cells and wider than the smallest channels you want to resolve. For a 1-m DEM, 10 to 15 meter length scales work well. Plot these rasters, along with the threshold raster created by bldgrds, over a shaded relief image. Experiement with different threshold values to get a sense of how the upslope extent of mapped channels will vary with the chosen thresholds. Also evaluate these overlays to determine an appropriate minimum flow length overwhich the thresholds need to be met for channel initiation. Channel initiation.</p></li>
<li><p>If there are large rivers and water bodies in the study area, you may want to build a water mask for these areas. This can be done using program waterMaskByTopo, which uses the infrared band of NAIP imagery to identify open water. The water mask can be used with bldgrds to guide channel flow paths through these areas. There may be other sources of data for a water mask, such as the 2-D breaklines used to build river and lake polygons for the USGS 3DEP program.</p></li>
<li><p>Run program bldgrds with the threshold values for AS<sup>e</sup>, DEV, and tangential curvature determined in step 2 above. Bldgrds will generate raster files for flow direction and accumulation and a point shapefile of the channel nodes that compose the channel network. Evaluate the channel extent and resulting channel density, and adjust threshold values if needed. Use the node shapefile and the flow accumulation raster to identify flow diversions at roads and manually digitize a road-crossing polyline shapefile. Identify errors in channel courses and manually digitize corrections to use as a channel mask.</p></li>
<li><p>Run bldgrds again with the adjusted thresholds, and the water mask, channel mask, and road-crossing shapefiles. Check the output channel network. Repeat until no further issues are identified.</p></li>
</ol>
<p>Bldgrds stores the output channel network in a binary data file called nodeNet_ID.dat. This is now available for all other NetStream programs.</p>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-clarke2008a" class="csl-entry" role="listitem">
Clarke, Sharon E., Kelly M. Burnett, and Daniel J. Miller. 2008. <span>“Modeling Streams and Hydrogeomorphic Attributes in Oregon from Digital and Field Data.”</span> <em>Journal of the American Water Resources Association</em> 44 (2): 459–77. <a href="https://doi.org/DOI: 10.1111/j.1752-1688.2008.00175.x">https://doi.org/DOI: 10.1111/j.1752-1688.2008.00175.x</a>.
</div>
<div id="ref-gallant2011" class="csl-entry" role="listitem">
Gallant, John C., and Michael F. Hutchinson. 2011. <span>“A Differential Equation for Specific Catchment Area.”</span> <em>Water Resources Research</em> 47 (5). <a href="https://doi.org/10.1029/2009wr008540">https://doi.org/10.1029/2009wr008540</a>.
</div>
<div id="ref-ijjasz-vasquez1995" class="csl-entry" role="listitem">
Ijjasz-Vasquez, and Rafael L. Bras. 1995. <span>“Scaling Regimes of Local Slope Versus Contributing Area in Digital Elevation Models.”</span> <em>Geomorphology</em> 12: 299–311.
</div>
<div id="ref-jasiewicz2013" class="csl-entry" role="listitem">
Jasiewicz, J., and T. F. Stepinski. 2013. <span>“Geomorphons - a Pattern Recognition Approach to Classification and Mapping of Landforms.”</span> <em>Geomorphology</em> 182: 147–56. <a href="https://doi.org/10.1016/j.geomorph.2012.11.005">https://doi.org/10.1016/j.geomorph.2012.11.005</a>.
</div>
<div id="ref-jenson1988" class="csl-entry" role="listitem">
Jenson, S. K., and J. O. Domingue. 1988. <span>“Extracting Topographic Structure from Digital Elevation Data for Geographic Information System Analysis.”</span> <em>Photogrammetric Engineering and Remote Sensing</em> 54 (11): 1593–1600.
</div>
<div id="ref-minár2020" class="csl-entry" role="listitem">
Minár, Jozef, Ian S. Evans, and Marián Jenčo. 2020. <span>“A Comprehensive System of Definitions of Land Surface (Topographic) Curvatures, with Implications for Their Application in Geoscience Modelling and Prediction.”</span> <em>Earth-Sc. Rev.</em> 211. <a href="https://doi.org/10.1016/j.earscirev.2020.103414">https://doi.org/10.1016/j.earscirev.2020.103414</a>.
</div>
<div id="ref-montgomery1993" class="csl-entry" role="listitem">
Montgomery, David R., and Efi Foufoula-Georgiou. 1993. <span>“Channel Network Source Representation Using Digital Elevation Models.”</span> <em>Water Resources Research</em> 29 (12): 3925–34.
</div>
<div id="ref-newman2018" class="csl-entry" role="listitem">
Newman, D. R., J. B. Lindsay, and J. M. H. Cockburn. 2018. <span>“Evaluating Metrics of Local Topographic Position for Multiscale Geomorphometric Analysis.”</span> <em>Geomorphology</em> 312: 40–50. <a href="https://doi.org/doi:10.1016/j.geomorph.2018.04.003">https://doi.org/doi:10.1016/j.geomorph.2018.04.003</a>.
</div>
<div id="ref-orlandini2003" class="csl-entry" role="listitem">
Orlandini, Stefano, Giovanni Moretti, Marco Franchini, Barbara Aldighieri, and Bruno Testa. 2003. <span>“Path-Based Methods for the Determination of Nondispersive Drainage Directions in Grid-Based Digital Elevation Models.”</span> <em>Water Resources Research</em> 39 (6). <a href="https://doi.org/10.1029/2002WR001639">https://doi.org/10.1029/2002WR001639</a>.
</div>
<div id="ref-soille2003" class="csl-entry" role="listitem">
Soille, Pierre, Jürgen Vogt, and Roberto Colombo. 2003. <span>“Carving and Adaptive Drainage Enforcement of Grid Digital Elevation Models.”</span> <em>Water Resources Research</em> 39 (12). <a href="https://doi.org/doi:10.1029/2002WR001879">https://doi.org/doi:10.1029/2002WR001879</a>.
</div>
<div id="ref-stepinski2011" class="csl-entry" role="listitem">
Stepinski, T. F., and Jasiewicz. J. 2011. <span>“Geomorphons - a New Approach to Classification of Landforms.”</span> <em>Proceedings of Geomorphometry</em>, 109–12.
</div>
<div id="ref-tarboton1997" class="csl-entry" role="listitem">
Tarboton, David G. 1997. <span>“A New Method for the Determination of Flow Directions and Upslope Areas in Grid Digital Elevation Models.”</span> <em>Water Resources Research</em> 33 (2): 309–19.
</div>
<div id="ref-wang2019" class="csl-entry" role="listitem">
Wang, Yi-Jie, Cheng-Zhi Qin, and A-Xing Zhu. 2019. <span>“Review on Algorithms of Dealing with Depressions in Grid DEM.”</span> <em>Annals of GIS</em> 25 (2): 83–97. <a href="https://doi.org/10.1080/19475683.2019.1604571">https://doi.org/10.1080/19475683.2019.1604571</a>.
</div>
<div id="ref-wilson2008" class="csl-entry" role="listitem">
Wilson, John P., Graeme Aggett, Deng Yongxin, and Christine S. Lam. 2008. <span>“Water in the Landscape: A Review of Contemporary Flow Routing Algorithms.”</span> In, edited by Qiming Zhou, Brian Lees, and Guo-an Tang, 213–36. Berlin: Springer.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./attributeLists.html" class="pagination-link" aria-label="Attribute Lists">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Attribute Lists</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./summary.html" class="pagination-link" aria-label="Summary">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Summary</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>&nbsp;This book was created with <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>




</body></html>