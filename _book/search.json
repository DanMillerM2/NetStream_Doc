[
  {
    "objectID": "intro.html",
    "href": "intro.html",
    "title": "1  Introduction",
    "section": "",
    "text": "Netstream is a library of Fortran programs used for geomorphic analysis, including the construction of attributed stream layers for use in a Geographic Information System (D. J. Miller 2003). The methods implemented in this library have proven effective for accurate channel-network delineation and attribution (Clarke, Burnett, and Miller 2008; Peñas et al. 2011; D. Miller et al. 2015); they form the foundation for the virtual watershed data structure (Barquin et al. 2015; Benda et al. 2016; González-Ferreras and Barquín 2017) and for the NetMap tools for ArcGIS (Benda et al. 2007). The programs are currently compiled for the Windows operating system and are run from a command line.\n\n\n\n\nBarquin, José, Lee E. Benda, Ferdinando Villan, Lee E. Brown, Nuria Bonada, David R. Vietes, Tom J. Battin, et al. 2015. “Coupling Virtual Watersheds with Ecosystem Services Assessment: A 21st Century Platform to Support River Research and Management.” WIREs Water 2 (6): 609–21. https://doi.org/10.1002/wat2.1106.\n\n\nBenda, Lee, Daniel J. Miller, Kevin Andras, Paul Bigelow, Gordon H. Reeves, and David Michael. 2007. “NetMap: A New Tool in Support of Watershed Science and Resource Management.” Forest Science 53 (2): 206–19. https://doi.org/https://doi.org/10.1093/forestscience/53.2.206.\n\n\nBenda, Lee, Daniel Miller, Jose Barquin, Richard J. McCleary, TiJiu Cai, and Y. Ji. 2016. “Building Virtual Watersheds: A Global Opportunity to Strengthen Resource Management and Conservation.” Environmental Management 57: 722–39. https://doi.org/10.1007/s00267-015-0634-6.\n\n\nClarke, Sharon E., Kelly M. Burnett, and Daniel J. Miller. 2008. “Modeling Streams and Hydrogeomorphic Attributes in Oregon from Digital and Field Data.” Journal of the American Water Resources Association 44 (2): 459–77. https://doi.org/DOI: 10.1111/j.1752-1688.2008.00175.x.\n\n\nGonzález-Ferreras, A. M., and J. Barquín. 2017. “Mapping the Temporary and Perennial Character of Whole River Networks.” Water Resources Research. https://doi.org/10.1002/2017wr020390.\n\n\nMiller, Daniel J. 2003. “Programs for DEM Analysis.” In. Fort Collins, CO, USA: USDA Forest Service, Rocky Mountain Research Station. https://www.fsl.orst.edu/clams/download/pubs/miller_DEM_Programs_2003.pdf.\n\n\nMiller, D., L. Benda, J. DePasquale, and D. Albert. 2015. “Creation of a Digital Flowline Network from IfSAR 5-m DEMs for the Matanuska-Susitna Basins: A Resource for Update of the National Hydrographic Dataset in Alaska.” https://www.conservationgateway.org/ConservationByGeography/NorthAmerica/UnitedStates/alaska/scak/Documents/Miller_etal_MatSu_Elevation_Derived_Flow_Network_Report.pdf.\n\n\nPeñas, Francisco J., Felipe Fernández, Mileno Calvo, José Barquín, and Luis Pedraz. 2011. “Influence of Data Sources and Processing Methods on Theoretical River Network Quality.” Limnetica 30 (2): 197–216. https://doi.org/DOI: 10.23818/limn.30.16.",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Introduction</span>"
    ]
  },
  {
    "objectID": "summary.html",
    "href": "summary.html",
    "title": "5  Summary",
    "section": "",
    "text": "Maybe we don’t need this.",
    "crumbs": [
      "<span class='chapter-number'>5</span>  <span class='chapter-title'>Summary</span>"
    ]
  },
  {
    "objectID": "references.html",
    "href": "references.html",
    "title": "References",
    "section": "",
    "text": "Barquin, José, Lee E. Benda, Ferdinando Villan, Lee E. Brown, Nuria\nBonada, David R. Vietes, Tom J. Battin, et al. 2015. “Coupling\nVirtual Watersheds with Ecosystem Services Assessment: A 21st Century\nPlatform to Support River Research and Management.” WIREs\nWater 2 (6): 609–21. https://doi.org/10.1002/wat2.1106.\n\n\nBenda, Lee, Daniel J. Miller, Kevin Andras, Paul Bigelow, Gordon H.\nReeves, and David Michael. 2007. “NetMap: A New Tool in Support of\nWatershed Science and Resource Management.” Forest\nScience 53 (2): 206–19. https://doi.org/https://doi.org/10.1093/forestscience/53.2.206.\n\n\nBenda, Lee, Daniel Miller, Jose Barquin, Richard J. McCleary, TiJiu Cai,\nand Y. Ji. 2016. “Building Virtual Watersheds: A Global\nOpportunity to Strengthen Resource Management and Conservation.”\nEnvironmental Management 57: 722–39. https://doi.org/10.1007/s00267-015-0634-6.\n\n\nClarke, Sharon E., Kelly M. Burnett, and Daniel J. Miller. 2008.\n“Modeling Streams and Hydrogeomorphic Attributes in Oregon from\nDigital and Field Data.” Journal of the American Water\nResources Association 44 (2): 459–77. https://doi.org/DOI:\n10.1111/j.1752-1688.2008.00175.x.\n\n\nGonzález-Ferreras, A. M., and J. Barquín. 2017. “Mapping the\nTemporary and Perennial Character of Whole River Networks.”\nWater Resources Research. https://doi.org/10.1002/2017wr020390.\n\n\nMiller, Daniel J. 2003. “Programs for DEM Analysis.” In.\nFort Collins, CO, USA: USDA Forest Service, Rocky Mountain Research\nStation. https://www.fsl.orst.edu/clams/download/pubs/miller_DEM_Programs_2003.pdf.\n\n\nMiller, D., L. Benda, J. DePasquale, and D. Albert. 2015.\n“Creation of a Digital Flowline Network from IfSAR 5-m DEMs for\nthe Matanuska-Susitna Basins: A Resource for Update of the National\nHydrographic Dataset in Alaska.” https://www.conservationgateway.org/ConservationByGeography/NorthAmerica/UnitedStates/alaska/scak/Documents/Miller_etal_MatSu_Elevation_Derived_Flow_Network_Report.pdf.\n\n\nPeñas, Francisco J., Felipe Fernández, Mileno Calvo, José Barquín, and\nLuis Pedraz. 2011. “Influence of Data Sources and Processing\nMethods on Theoretical River Network Quality.” Limnetica\n30 (2): 197–216. https://doi.org/DOI:\n10.23818/limn.30.16.",
    "crumbs": [
      "References"
    ]
  },
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "NetStream: Programs for watershed analyses",
    "section": "",
    "text": "Hello\nWelcome to the ever evolving documentation for NetStream, a suite of Fortran programs for watershed analyses. This book describes these programs and shows how to use them for certain types of tasks.",
    "crumbs": [
      "Hello"
    ]
  },
  {
    "objectID": "Bldgrds.html",
    "href": "Bldgrds.html",
    "title": "3  bldgrds",
    "section": "",
    "text": "3.1 Input data files\nBldgrds creates a digital representation of a channel network; a “stream layer” in GIS terminology. The steps for doing that are described in Chapter 4.",
    "crumbs": [
      "Programs",
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>bldgrds</span>"
    ]
  },
  {
    "objectID": "InputFile.html",
    "href": "InputFile.html",
    "title": "2  Input Files",
    "section": "",
    "text": "Programs in the Netstream suite all use ascii (text) input files with a similar file structure and format. The input files specify any input and output file names and locations, specify the tasks to be performed, and provide any parameter values needed to perform those tasks. They use a keyword: argument(s) format. The keyword indicates either what the following arguments are for or indicates a specific task or program option. Entries are identified as a keyword by the following colon (:), any needed arguments follow the keyword; multiple arguments are separated by commas; and if an argument specifies a numerical or logical parameter name, its value is specified after an equal sign. A pound sign (#) indicates a comment; any unrecognized entries are ignored (so if you misspell a keyword, it will be ignored). Examples follow.",
    "crumbs": [
      "Programs",
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Input Files</span>"
    ]
  },
  {
    "objectID": "CreateStreamLayer.html",
    "href": "CreateStreamLayer.html",
    "title": "4  Build a stream layer",
    "section": "",
    "text": "4.1 Tasks\nIt seems straightforward: define a flow direction for each DEM cell, iteratively trace flow lines downstream summing cell area as we go to create a flow accumulation raster, set a flow threshold, and voila, a stream layer. That’s basically it, but there are complications. The first two items below discuss issues that are hardwired into bldgrds. Everything else has user-defined options, although default values are built in for most.\nBasin topography is found to exhibit certain scaling relationships between contributing area and gradient that delineate divergent, convergent, and channelized topography (Ijjasz-Vasquez and Bras, 1995). We capitalize on these to calibrate threshold values for channel initiation. Following Clarke et al. (2008), we plot channel density as a function of the ASe value and look for the inflection in log-log plots that indicate a transition to the channelized regime. See Slide 4. This provides a ball-park estimate of the threshold value appropriate for the terrain as represented with the DEM. Plots are produced separately for steep terrain and low-gradient terrain, under the assumption that channel-forming processes may differ, e.g., landsliding on steep terrain and fluvial erosion on low-gradient terrain. See examples in Slides 4-5.\nWith high-resolution DEMs, a default strategy for channel initiation and flow-path routing is:\nChannel initiation.\nChannelized flow routing.",
    "crumbs": [
      "Tasks",
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Build a stream layer</span>"
    ]
  },
  {
    "objectID": "programs.html",
    "href": "programs.html",
    "title": "Programs",
    "section": "",
    "text": "The library includes the following primary programs (in alphabetical order):\n\naddData: adds requested attributes to an existing stream-layer shapefile created previously with netrace.\nbarrier: identifies physical barriers to fish passage; requires a channel-node stream layer created from a high-resolution (lidar) DEM\nbldgrds: Builds a stream layer as a linked-node list from a DEM, stored in a binary data file. Auxiliary outputs include flow-accumulation and flow-direction rasters. The binary stream-layer file is read by all subsequent programs that use the stream layer.\nclosedDepressions: delineate all closed depressions within a DEM; optionally filter by size.\nDEV: calculate topographic position index values over specified length scales. Includes local relief and deviation from mean elevation (DEV).\nmakeGrids: builds rasters of elevation derivatives.\nmerge: merge high- and low-resolution DEMs into a single DEM. DEMs are warped over a specified length scale to prevent discontinuities at the seams.\nmergeToHigh: merge two high-resolution DEMs, ensuring a smooth transition from one to the other.\nnetrace: reads the binary stream-layer file and builds point and/or polyline shapefiles readable by any GIS. Calculates requested attributes for each record.\nvalleyFloor: builds a binary data file giving elevation above the channel. This data file can be used to determine valley widths at specified elevations above a channel and to create raster files showing elevation relative to the channel (i.e., “height-above-channel” rasters).\nwaterMaskByTopo: create a mask delineating open water using infrared band imagery and a DEM. Used by bldgrds when constructing a stream layer.\nwatershed: delineates the contributing area to specified points on the channel-node stream layer. Used, for example, to create a nested hierarchy of basins (e.g., Hydrologic Unit Code basins).\nmore to come",
    "crumbs": [
      "Programs"
    ]
  },
  {
    "objectID": "CreateStreamLayer.html#tasks-to-build-a-stream-layer",
    "href": "CreateStreamLayer.html#tasks-to-build-a-stream-layer",
    "title": "4  Build a stream layer",
    "section": "",
    "text": "Flow direction from a DEM cell is not uniquely defined. Each cell has 8 adjacent cells. Depending on the shape of the ground surface interpolated from the 9 elevation values at the midpoints of the cells, each adjacent cell may contribute all, some portion, or none of its area to the central cell and the central cell may contribute all, some portion, or none of its area (and the accumulated area of the upslope cells that flows into it) to each of the adjacent cells. The simplest strategy is to have all flow from the central cell go to one of the 8 adjacent cells. This is the “D-8” flow-direction algorithm (Jenson and Domingue, 1988). It provides a poor estimate of contributing area to a cell that is biased by the 8 flow-direction options. One must also decide which of the 8 adjacent cells to direct flow to, and there are a variety of strategies for that. When D-8 flow paths are needed, we use the D8-LTD algorithm (Orlandini et al., 2003), which corrects for the directional bias. A variety of flow-direction algorithms have been developed that accommodate flow in any direction and can direct flow to multiple downslope adjacent cells (Wilson et al., 2008) and thus allow for flow dispersion. We use the D-infinity algorithm (Tarboton, 1997), which allows flow into one or two adjacent cells. Flow accumulation is then calculated using the D-infinity flow directions, until the criteria for channel initiation are met. Downslope of that point, we use D-8 to prevent flow dispersion out of the channel.\nClosed depressions. These may be actual depressions with no outflow, in which case all inflowing water infiltrates to groundwater, or they be actual depressions with an outflow not visible from the DEM (e.g., road prisms with culverts), or they may be artifacts or errors in the DEM. In general, we want to define a flow path to an outlet from the DEM for every DEM cell. Even for closed depressions with no outlet, water that flows into them exits through some groundwater flow path and eventually flows to a stream somewhere downslope or out of the area represented with the DEM. Two primary approaches are used to deal with closed depressions.\n\nFilling. This is the simplest. The depression is filled to the elevation of its lowest pour point (where water would spill out if the depression were filled). Flow directions through the closed depression are then directed toward the pour point. This option destroys any information about flow directions within the closed depression, which we would rather avoid.\nCarving. A path is carved from the depression pour point to the lowest point in the depression and from to a location along the flow path from the pour point where the elevation becomes less than or equal to the lowest point in the depression. Flow within the depression is then directed to the lowest point and then out of the depression along the carved path (Soille et al., 2003). The flow paths from the pour point heading into and away from the depression follow D8-LTD flow directions. This is the preferred option and the one used in bldgrds. \n\nChannel initiation. We need to specify the conditions where channels initiate. This determines the upslope extent of the channel network and the channel density. We have several strategies:\n\nLocal topographic position. For high-resolution DEMs interpolated from high-density ground returns (e.g., &gt;1/m2), channels are visible directly in the DEM. Channels can be highlighted using a measure of local topographic position (LTP), which provides an indicator of the elevation of a DEM grid point relative to its neighbors. Absolute LTP measures give the difference in elevation of the grid point compared to the mean or median grid-point elevations within a specified circular neighborhood. Relative measures normalize that elevation difference by some measure of elevation variability in the neighborhood. Deviation from mean elevation (DEV), for example, divides the difference from mean elevation by the standard deviation of DEM grid-point elevations within the neighborhood (Newman et al., 2018). Thus, a small channel incised 0.25 meters traversing flat, low-relief terrain (with a small standard deviation in elevation values) will have a large DEV value compared to a small channel incised 0.25 meters traversing steep, rough terrain (with a larger standard deviation). For determining upslope channel extent, we can specify an LTP threshold value and exclude channel initiation in areas where the LTP value is greater than that threshold (i.e., channel incision is too small). One must decide on whether to use an absolute or relative measure and on the appropriate length scale for the local neighborhood. I find an absolute measure easier to interpret than a relative measure, because it provides a direct estimate of the depth of channel incision; I can decide that traced channels begin only when a channel is incised to more than 0.2 meters (LTP &lt; -0.2), for example. The radius to choose for the local neighborhood should be set relative to the resolution of the DEM, the roughness of the terrain (greater roughness requires larger neighborhoods), and the smallest width of channels you want to identify. Typically, at their upslope extent, channels are less than a meter wide, so a radius of five meters or more will suffice for calculating LTP. See slides 1-2 for examples in the Sprague basin. \nArea-slope threshold. Where the ground-return point density is insufficient to resolve channels at their upslope extent, we need to infer channel-initiation locations. One strategy for this is to estimate where on the landscape there is sufficient flowing water to erode a channel. The contributing (drainage) area to any point on the landscape indicates the upslope area from which overland flow and water infiltrating to shallow subsurface flow through the soil can originate. Hence, differences in contributing area provide indicators of relative differences in overland- and shallow-subsurface discharge; greater contributing area implies greater discharge. This is the idea behind using thresholds in contributing area to estimate upslope channel extent: for a given climate and terrain, some minimum contributing area is required for sufficient discharge to erode a channel. The erosive power of water depends not only on how much water there is, but also on the steepness of the slope it is flowing over or through. Hence, threshold values for functions of contributing area and ground-surface slope may provide better indicators of where channels initiate than contributing area alone. We use the function ASe, where A is contributing area, S is tangent of the ground-surface gradient, and e is a user-specified exponent (Montgomery and Foufoula-Georgiou, 1993). Contributing area may be specified as specific contributing area, which is the contributing area divided by the length of a contour line crossed by flow exiting the DEM cell (Gallant and Hutchinson, 2011). This accounts for effects of topographic convergence and divergence on the depth of flow and is the default in bldgrds. \n\n\n\n\nPlan curvature. Plan curvature measures the rate of change in elevation measured in a direction tangent to a contour line; it indicates the curvature of the contour. Tangential curvature is similar, but measures the rate of change relative to a plane oriented tangent to the ground surface, whereas plan curvature measures curvature relative to a horizontal plane (Minár et al., 2020). Both provide another measure for topographic indication of presence of a channel. Bldgrds has the option to specify thresholds of plan (or tangential) curvature for channel initiation. These thresholds can be determined by building curvature rasters using the makegrids program, classifying by proposed threshold values, and plotting on a shaded relief image to see where a proposed threshold would allow channel initiation. The LTP thresholds described above provide a similar and more easily interpreted method of using topography inferred from the DEM for identifying channels.\nMinimum flow length. Bldgrds iteratively traverses every flow path within a DEM in a downslope direction and checks each cell to see if it meets the channel-initiation criteria. As seen in the images of slides 1, 2, and 5, the criteria can be met for some portion of the flow path, but then no longer be met further downslope. Bldgrds requires specification of the minimum length over which the initiation criteria must be met before it will initialize a channel. The appropriate length depends on the resolution of the DEM and on the roughness of the terrain. If topographic channel indicators are indistinct, small zones where initiation thresholds are met can arise from noise in the DEM or small-scale roughness in the terrain. \n\n\n\nChannel courses. The cell-to-cell D8 flow paths used once channel initiation is met do not always follow the same course that the actual channels do. Sometimes evidence of the channel flow path is not visible in the DEM, sometimes there are multiple options, sometimes noise in the DEM misdirects the flow path. It can help to use information from DEM cells beyond those immediately adjacent and to bring in information from other data sources. Here are options used by bldgrds.\n\nFlow indicators. Topographic indicators of a channel can also be used to guide channelized flow paths. The flowcat program (for flow categorization) uses one to four such indicators: 1) a threshold in flow accumulation calculated with D-infinity flow directions and no channel initiation, 2) geomorphon valley and pit types (Stepinski and Jasiewicz. J, 2011; Jasiewicz and Stepinski, 2013), 3) a threshold in plan (or tangential) curvature, and 4) a threshold for deviation from mean elevation (DEV). FlowCat creates a raster with each cell indicating the number of specified flow indicators that are met at each DEM cell. If all four indicators are used, then raster values range from 0 to 4. Bldgrds preferentially directs channels towards raster-cell values greater than zero, or greater than a specified minimum (e.g., if all four indicators are used, a minimum of two indicators must be met). This is done by excavating the corresponding cells in the DEM by a multiple of the flow-indicator raster. \nWater mask. Infrared laser signals are absorbed by water so there are no signal returns from open water. Lidar DEMs often have areas of water “hydroflattened”, so that the open-water zone has a single uniform elevation or a uniformly downstream decreasing elevation. In other cases, elevations over the open-water zone are interpolated from ground returns on either side, which can generate noisy DEM elevation values through the zone of open water. This can result in zig-zaggy flow paths, which then overestimate channel length and affect values of corresponding derivatives, such channel gradient. We want channel flow paths through zones of open water to be smooth and to track through the center of the open-water zone. To accomplish that, provide bldgrds with a separate raster or polygonal water-mask layer. Bldgrds will direct flow paths through the center of these zones. In some cases, breaklines for hydroflattening are provided with lidar-derived DEMs. In other cases, we can build a water mask using multi-band imagery. Open water appears dark in infra-red bands and can be delineated using image segmentation. Program waterMaskByTopo can generate a water-mask raster using the infrared band from e.g., NAIP. It also uses thresholds in DEV and gradient to distinguish shadows. \nDEM derivatives. Azimuth, plan curvature, and the direction of steepest descent can also be used with varying degrees of influence to guide channelized flow directions. Azimuth and plan curvature are measured over a specified length scale. By specifying a length greater than the DEM grid-point spacing, azimuth and curvature use information beyond the elevation of adjacent points, which can reduce the influence of noise in the DEM. It can also cause flow paths to deviate from the steepest-descent path to an adjacent cell. One or more of these indicators may be used and, if more than one are specified, different degrees of influence can be specified for each. The choice of indicators, of length scales, and of the degree of influence to specify requires iterative experimentation.\nFlow diversions. High-resolution lidar DEMs resolve road prisms and other potential blockages to channel flow. The carving algorithm used to drain closed depressions will often trace the correct flow path, but not in all cases. If these apparent blockages have drainage structures, such as culverts, not visible in the DEM, these need to be specified from other data sources. Typically, such other data sources are not available, and the likely locations of culverts need to be manually digitized. This task is iterative: building a stream layer, looking for diversions, digitizing a culvert or drainage location, rebuilding the stream layer, and repeating until satisfied with the stream layer. \n\n\n\n\n\nUse thresholds of local relief for low- and high-gradient terrain, along with \narea-slope thresholds to limit the extent that channel features resolvable in the DEM are traced upslope. \n\n\n\nUse elevation derivatives of azimuth and plan curvature, with these values calculated over length scales sufficient to span several DEM cells. \nUse a water mask derived using the waterMaskByTopo program with the infrared NAIP band. \nIterative correction of flow diversions.",
    "crumbs": [
      "Tasks",
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Build a stream layer</span>"
    ]
  },
  {
    "objectID": "CreateStreamLayer.html#linked-node-data-structure",
    "href": "CreateStreamLayer.html#linked-node-data-structure",
    "title": "4  Build a stream layer",
    "section": "4.2 Linked node data structure",
    "text": "4.2 Linked node data structure\nThe channel network traced by bldgrds is represented using a linked-node data structure. A channel node is created for each DEM grid point along the channel flow path. Each channel node is connected to one or more upstream nodes and to one downstream node. (The data structure can accommodate multiple downstream nodes, but I haven’t fully implemented that yet. We need it to route through anastomosing channel networks, but I’m still working on efficient and robust ways to trace through networks with multiple loops). Each node has an associated set of attributes. This set may include such attributes as elevation, contributing area, channel geometry, channel gradient, and a variety of others available through instructions specified in the input files to the programs. Each node is associated with a DEM grid point, but node locations may be displaced from the grid point to accommodate smooth flow paths. \nBldgrds builds a binary data file that stores the channel-node list that specifies the node locations and the node-to-node connections. Any subsequent program that uses the traced channel network reads this file to construct the channel network. The file is named nodeNet_ID.dat, where “ID” is a text string used to identify a dataset. \ninsert figure",
    "crumbs": [
      "Tasks",
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Build a stream layer</span>"
    ]
  },
  {
    "objectID": "CreateStreamLayer.html#tasks",
    "href": "CreateStreamLayer.html#tasks",
    "title": "4  Build a stream layer",
    "section": "",
    "text": "Flow direction from a DEM cell is not uniquely defined. Each cell has 8 adjacent cells. Depending on the shape of the ground surface interpolated from the 9 elevation values at the midpoints of the cells, each adjacent cell may contribute all, some portion, or none of its area to the central cell and the central cell may contribute all, some portion, or none of its area (and the accumulated area of the upslope cells that flows into it) to each of the adjacent cells. The simplest strategy is to have all flow from the central cell go to one of the 8 adjacent cells. This is the “D-8” flow-direction algorithm (Jenson and Domingue, 1988). It provides a poor estimate of contributing area to a cell that is biased by the 8 flow-direction options. One must also decide which of the 8 adjacent cells to direct flow to, and there are a variety of strategies for that. When D-8 flow paths are needed, we use the D8-LTD algorithm (Orlandini et al., 2003), which corrects for the directional bias. A variety of flow-direction algorithms have been developed that accommodate flow in any direction and can direct flow to multiple downslope adjacent cells (Wilson et al., 2008) and thus allow for flow dispersion. We use the D-infinity algorithm (Tarboton, 1997), which allows flow into one or two adjacent cells. Flow accumulation is then calculated using the D-infinity flow directions, until the criteria for channel initiation are met. Downslope of that point, we use D-8 to prevent flow dispersion out of the channel.\nClosed depressions. These may be actual depressions with no outflow, in which case all inflowing water infiltrates to groundwater, or they be actual depressions with an outflow not visible from the DEM (e.g., road prisms with culverts), or they may be artifacts or errors in the DEM. In general, we want to define a flow path to an outlet from the DEM for every DEM cell. Even for closed depressions with no outlet, water that flows into them exits through some groundwater flow path and eventually flows to a stream somewhere downslope or out of the area represented with the DEM. Two primary approaches are used to deal with closed depressions.\n\nFilling. This is the simplest. The depression is filled to the elevation of its lowest pour point (where water would spill out if the depression were filled). Flow directions through the closed depression are then directed toward the pour point. This option destroys any information about flow directions within the closed depression, which we would rather avoid.\nCarving. A path is carved from the depression pour point to the lowest point in the depression and from to a location along the flow path from the pour point where the elevation becomes less than or equal to the lowest point in the depression. Flow within the depression is then directed to the lowest point and then out of the depression along the carved path (Soille et al., 2003). The flow paths from the pour point heading into and away from the depression follow D8-LTD flow directions. This is the preferred option and the one used in bldgrds. \n\nChannel initiation. We need to specify the conditions where channels initiate. This determines the upslope extent of the channel network and the channel density. We have several strategies:\n\nLocal topographic position. For high-resolution DEMs interpolated from high-density ground returns (e.g., &gt;1/m2), channels are visible directly in the DEM. Channels can be highlighted using a measure of local topographic position (LTP), which provides an indicator of the elevation of a DEM grid point relative to its neighbors. Absolute LTP measures give the difference in elevation of the grid point compared to the mean or median grid-point elevations within a specified circular neighborhood. Relative measures normalize that elevation difference by some measure of elevation variability in the neighborhood. Deviation from mean elevation (DEV), for example, divides the difference from mean elevation by the standard deviation of DEM grid-point elevations within the neighborhood (Newman et al., 2018). Thus, a small channel incised 0.25 meters traversing flat, low-relief terrain (with a small standard deviation in elevation values) will have a large DEV value compared to a small channel incised 0.25 meters traversing steep, rough terrain (with a larger standard deviation). For determining upslope channel extent, we can specify an LTP threshold value and exclude channel initiation in areas where the LTP value is greater than that threshold (i.e., channel incision is too small). One must decide on whether to use an absolute or relative measure and on the appropriate length scale for the local neighborhood. I find an absolute measure easier to interpret than a relative measure, because it provides a direct estimate of the depth of channel incision; I can decide that traced channels begin only when a channel is incised to more than 0.2 meters (LTP &lt; -0.2), for example. The radius to choose for the local neighborhood should be set relative to the resolution of the DEM, the roughness of the terrain (greater roughness requires larger neighborhoods), and the smallest width of channels you want to identify. Typically, at their upslope extent, channels are less than a meter wide, so a radius of five meters or more will suffice for calculating LTP. See slides 1-2 for examples in the Sprague basin. \nArea-slope threshold. Where the ground-return point density is insufficient to resolve channels at their upslope extent, we need to infer channel-initiation locations. One strategy for this is to estimate where on the landscape there is sufficient flowing water to erode a channel. The contributing (drainage) area to any point on the landscape indicates the upslope area from which overland flow and water infiltrating to shallow subsurface flow through the soil can originate. Hence, differences in contributing area provide indicators of relative differences in overland- and shallow-subsurface discharge; greater contributing area implies greater discharge. This is the idea behind using thresholds in contributing area to estimate upslope channel extent: for a given climate and terrain, some minimum contributing area is required for sufficient discharge to erode a channel. The erosive power of water depends not only on how much water there is, but also on the steepness of the slope it is flowing over or through. Hence, threshold values for functions of contributing area and ground-surface slope may provide better indicators of where channels initiate than contributing area alone. We use the function ASe, where A is contributing area, S is tangent of the ground-surface gradient, and e is a user-specified exponent (Montgomery and Foufoula-Georgiou, 1993). Contributing area may be specified as specific contributing area, which is the contributing area divided by the length of a contour line crossed by flow exiting the DEM cell (Gallant and Hutchinson, 2011). This accounts for effects of topographic convergence and divergence on the depth of flow and is the default in bldgrds. \n\n\n\n\nPlan curvature. Plan curvature measures the rate of change in elevation measured in a direction tangent to a contour line; it indicates the curvature of the contour. Tangential curvature is similar, but measures the rate of change relative to a plane oriented tangent to the ground surface, whereas plan curvature measures curvature relative to a horizontal plane (Minár et al., 2020). Both provide another measure for topographic indication of presence of a channel. Bldgrds has the option to specify thresholds of plan (or tangential) curvature for channel initiation. These thresholds can be determined by building curvature rasters using the makegrids program, classifying by proposed threshold values, and plotting on a shaded relief image to see where a proposed threshold would allow channel initiation. The LTP thresholds described above provide a similar and more easily interpreted method of using topography inferred from the DEM for identifying channels.\nMinimum flow length. Bldgrds iteratively traverses every flow path within a DEM in a downslope direction and checks each cell to see if it meets the channel-initiation criteria. As seen in the images of slides 1, 2, and 5, the criteria can be met for some portion of the flow path, but then no longer be met further downslope. Bldgrds requires specification of the minimum length over which the initiation criteria must be met before it will initialize a channel. The appropriate length depends on the resolution of the DEM and on the roughness of the terrain. If topographic channel indicators are indistinct, small zones where initiation thresholds are met can arise from noise in the DEM or small-scale roughness in the terrain. \n\n\n\nChannel courses. The cell-to-cell D8 flow paths used once channel initiation is met do not always follow the same course that the actual channels do. Sometimes evidence of the channel flow path is not visible in the DEM, sometimes there are multiple options, sometimes noise in the DEM misdirects the flow path. It can help to use information from DEM cells beyond those immediately adjacent and to bring in information from other data sources. Here are options used by bldgrds.\n\nFlow indicators. Topographic indicators of a channel can also be used to guide channelized flow paths. The flowcat program (for flow categorization) uses one to four such indicators: 1) a threshold in flow accumulation calculated with D-infinity flow directions and no channel initiation, 2) geomorphon valley and pit types (Stepinski and Jasiewicz. J, 2011; Jasiewicz and Stepinski, 2013), 3) a threshold in plan (or tangential) curvature, and 4) a threshold for deviation from mean elevation (DEV). FlowCat creates a raster with each cell indicating the number of specified flow indicators that are met at each DEM cell. If all four indicators are used, then raster values range from 0 to 4. Bldgrds preferentially directs channels towards raster-cell values greater than zero, or greater than a specified minimum (e.g., if all four indicators are used, a minimum of two indicators must be met). This is done by excavating the corresponding cells in the DEM by a multiple of the flow-indicator raster. \nWater mask. Infrared laser signals are absorbed by water so there are no signal returns from open water. Lidar DEMs often have areas of water “hydroflattened”, so that the open-water zone has a single uniform elevation or a uniformly downstream decreasing elevation. In other cases, elevations over the open-water zone are interpolated from ground returns on either side, which can generate noisy DEM elevation values through the zone of open water. This can result in zig-zaggy flow paths, which then overestimate channel length and affect values of corresponding derivatives, such channel gradient. We want channel flow paths through zones of open water to be smooth and to track through the center of the open-water zone. To accomplish that, provide bldgrds with a separate raster or polygonal water-mask layer. Bldgrds will direct flow paths through the center of these zones. In some cases, breaklines for hydroflattening are provided with lidar-derived DEMs. In other cases, we can build a water mask using multi-band imagery. Open water appears dark in infra-red bands and can be delineated using image segmentation. Program waterMaskByTopo can generate a water-mask raster using the infrared band from e.g., NAIP. It also uses thresholds in DEV and gradient to distinguish shadows. \nDEM derivatives. Azimuth, plan curvature, and the direction of steepest descent can also be used with varying degrees of influence to guide channelized flow directions. Azimuth and plan curvature are measured over a specified length scale. By specifying a length greater than the DEM grid-point spacing, azimuth and curvature use information beyond the elevation of adjacent points, which can reduce the influence of noise in the DEM. It can also cause flow paths to deviate from the steepest-descent path to an adjacent cell. One or more of these indicators may be used and, if more than one are specified, different degrees of influence can be specified for each. The choice of indicators, of length scales, and of the degree of influence to specify requires iterative experimentation.\nFlow diversions. High-resolution lidar DEMs resolve road prisms and other potential blockages to channel flow. The carving algorithm used to drain closed depressions will often trace the correct flow path, but not in all cases. If these apparent blockages have drainage structures, such as culverts, not visible in the DEM, these need to be specified from other data sources. Typically, such other data sources are not available, and the likely locations of culverts need to be manually digitized. This task is iterative: building a stream layer, looking for diversions, digitizing a culvert or drainage location, rebuilding the stream layer, and repeating until satisfied with the stream layer. \n\n\n\n\n\nUse thresholds of local relief for low- and high-gradient terrain, along with \narea-slope thresholds to limit the extent that channel features resolvable in the DEM are traced upslope. \n\n\n\nUse elevation derivatives of azimuth and plan curvature, with these values calculated over length scales sufficient to span several DEM cells. \nUse a water mask derived using the waterMaskByTopo program with the infrared NAIP band. \nIterative correction of flow diversions.",
    "crumbs": [
      "Tasks",
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Build a stream layer</span>"
    ]
  },
  {
    "objectID": "Bldgrds.html#output-data-files",
    "href": "Bldgrds.html#output-data-files",
    "title": "3  bldgrds",
    "section": "3.2 Output data files",
    "text": "3.2 Output data files",
    "crumbs": [
      "Programs",
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>bldgrds</span>"
    ]
  },
  {
    "objectID": "Bldgrds.html#keyword-argument-options",
    "href": "Bldgrds.html#keyword-argument-options",
    "title": "3  bldgrds",
    "section": "3.3 Keyword: argument options",
    "text": "3.3 Keyword: argument options",
    "crumbs": [
      "Programs",
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>bldgrds</span>"
    ]
  },
  {
    "objectID": "Bldgrds.html#keyword-arguments",
    "href": "Bldgrds.html#keyword-arguments",
    "title": "3  bldgrds",
    "section": "3.3 Keyword: arguments",
    "text": "3.3 Keyword: arguments\nAnything else?",
    "crumbs": [
      "Programs",
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>bldgrds</span>"
    ]
  }
]